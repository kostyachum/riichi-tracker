{% extends 'base.html' %}
{% load humanize %}
{% load i18n %}

{% block header-control %}
  <a href="/" class="text-sky-700 hover:underline text-sm font-medium shrink-0">{% trans "← Back to games" %}</a>
  {{ block.super }}
{% endblock %}

{% block content %}

  <header class="flex flex-col gap-3 items-start justify-between mb-6 mt-2">

    <section class="flex gap-4 items-start">
      <img src="{{ player.avatar.file.url }}" width="100" height="100" class="border rounded-md"/>
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">
          {{ player.name }}
        </h1>

        <div>{% trans "Clubs:" %} {% for club in player.clubs.all %}
          {{ club.name }}{% if not forloop.last %}, {% endif %}
          {% empty %}
            {% trans "Hasn’t joined a club" %}
          {% endfor %}
        </div>

        <!-- Stats summary -->
        <div class="flex flex-wrap gap-2 mt-2">
          <div class="badge badge-outline text-sm">{% trans "Games:" %} {{ games|length }}</div>
          <div class="badge badge-outline">{% trans "Wins:" %} {{ stats.wins }}</div>
          <div class="badge badge-outline">{% trans "Win Rate:" %} {{ stats.win_rate|floatformat:1 }}%</div>
          <div class="badge badge-outline">{% trans "Average Rank:" %} {{ stats.avg_rank|floatformat:2 }}</div>
          <div class="badge badge-outline text-sm">
            {% trans "Average Result:" %} {{ stats.avg_score|floatformat:1 }}
          </div>
          <div class="badge badge-outline text-sm">
            {% trans "Average Points:" %} {{ stats.avg_raw|floatformat:0 |intcomma }}
          </div>
        </div>
      </div>
    </section>
  </header>

  {% if games %}
    <!-- Chart container -->
    <h2 class="font-semibold text-lg mb-4">{% trans "Trends" %}</h2>
    <div class="card bg-base-100 shadow-md p-4">
      <div class="relative h-48">
        <canvas id="rankTrendChart" class="w-full block"></canvas>
      </div>
    </div>

    <h2 class="font-semibold text-lg mb-4 mt-8">{% trans "Recent Games" %}</h2>

    <!-- Games list -->
    <div class="space-y-4 ">
      {% for game in games %}
        {% include "games/game_card.html" with game=game target_player_id=player.id %}
      {% endfor %}
    </div>
  {% else %}
    <div class="rounded-lg border border-dashed border-slate-300 bg-white p-8 text-center">
      <p class="text-slate-600">{% blocktrans with player_name=player.name %}No games found for {{ player_name }}.{% endblocktrans %}</p>
    </div>
  {% endif %}

{% endblock %}


{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
      const ctx = document.getElementById('rankTrendChart');
      const data = {
          labels: [...Array({{ recent_ranks|length }})].map((_, i) => i + 1),
          datasets: [{
              data: {{ recent_ranks|safe }},
              borderColor: '#f97316',
              backgroundColor: '#facc15',
              fill: false,
              pointRadius: 5,
              borderWidth: 2,
              clip: false,
          }]
      };
      const options = {
          responsive: true,
          maintainAspectRatio: false,
          layout: {
              padding: {
                  top: 8,
                  bottom: 8,
              },
          },
          scales: {
              y: {
                  reverse: true,
                  min: 1,
                  max: 4,
                  ticks: {
                      stepSize: 1,
                      callback: v => ['1st', '2nd', '3rd', '4th'][v - 1] || ''
                  },
              },
              x: {grid: {display: false},}
          },
          plugins: {legend: {display: false}}
      }

      new Chart(ctx, {type: 'line', data, options});

  </script>
{% endblock %}
